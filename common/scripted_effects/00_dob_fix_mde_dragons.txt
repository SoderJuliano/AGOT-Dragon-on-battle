# ============================================================
# DRAGON ON BATTLE - Fix MDE Broken Dragons
# Conserta dragões criados pelo More Dragon Eggs que não foram
# registrados no sistema de armazenamento do AGOT (gl_dragon_variable_storage).
#
# CAUSA RAIZ:
#   AGOT armazena dragon_size_base em uma global list (gl_dragon_variable_storage)
#   via story cycles. Dragões criados por mods que não chamam
#   agot_dragon_transfer_vars_to_story_cycle_effect ficam invisíveis para esse
#   sistema → dragon_size sempre retorna 0 → Tame/Rename desabilitados.
#
# SOLUÇÃO:
#   Detectar dragões sem entrada no storage system (var:dragon_id não encontrado
#   em nenhuma story na gl_dragon_variable_storage) e chamar a função oficial do
#   AGOT para registrá-los, estimando dragon_size_base pela idade do personagem.
#
# Scope: o DRAGÃO (has_trait = dragon)
# ============================================================

# Estima dragon_size_base baseado na idade do dragão.
# Fórmula baseada na taxa de crescimento do AGOT:
#   Age < 11: +3 size/year (young phase)
#   Age 11-15: +2 size/year (adolescent)
#   Age 15+: +~1 size/year (adult, já crescido)
# Valores aproximados, conservadores (sem traits de physique).
dob_estimate_dragon_size_from_age = {
	if = {
		limit = { age >= 80 }
		set_variable = { name = dragon_size_base value = 175 }
	}
	else_if = {
		limit = { age >= 60 }
		set_variable = { name = dragon_size_base value = 150 }
	}
	else_if = {
		limit = { age >= 45 }
		set_variable = { name = dragon_size_base value = 120 }
	}
	else_if = {
		limit = { age >= 30 }
		set_variable = { name = dragon_size_base value = 90 }
	}
	else_if = {
		limit = { age >= 20 }
		set_variable = { name = dragon_size_base value = 60 }
	}
	else_if = {
		limit = { age >= 15 }
		set_variable = { name = dragon_size_base value = 40 }
	}
	else_if = {
		limit = { age >= 10 }
		set_variable = { name = dragon_size_base value = 30 }
	}
	else_if = {
		limit = { age >= 5 }
		set_variable = { name = dragon_size_base value = 15 }
	}
	else = {
		set_variable = { name = dragon_size_base value = 5 }
	}
}

# Verifica se este dragão está faltando no storage system do AGOT.
# Scope: o DRAGÃO (this = dragon, dentro de any_in_global_list: this=story, prev=dragon)
dob_dragon_missing_from_agot_storage = {
	NOT = {
		# Existe alguma story no global list onde dragon_id = este dragão?
		any_in_global_list = {
			variable = gl_dragon_variable_storage
			var:dragon_id ?= prev
		}
	}
}

# Conserta um único dragão quebrado.
# Scope: o DRAGÃO (has_trait = dragon)
# Chamado de dentro de loops.
dob_fix_single_dragon_storage = {
	# ── Garantir que dragon_size_base existe no personagem ────────────────────────
	# O on_setup do story_dragon_variable_storage lê scope:dragon.var:dragon_size_base
	# Se não existir, o storage inicia com size 0 (mesmo que correto, mas é melhor estimar)
	if = {
		limit = { NOT = { has_variable = dragon_size_base } }
		dob_estimate_dragon_size_from_age = yes
	}
	else_if = {
		# Tem a variável mas ela está em 0 (MDE não inicializou corretamente)
		limit = { var:dragon_size_base <= 0 }
		dob_estimate_dragon_size_from_age = yes
	}

	# ── Garantir dragon_age no personagem ─────────────────────────────────────────
	# O storage cycle também armazena dragon_age — garante que está setado
	if = {
		limit = { NOT = { has_variable = dragon_age } }
		set_variable = {
			name = dragon_age
			value = { value = 0 add = age }
		}
	}

	# ── Registrar no sistema de storage do AGOT ───────────────────────────────────
	# agot_dragon_transfer_vars_to_story_cycle_effect:
	#   1. Cria um personagem temporário dummy em c_ruins.holder
	#   2. No after_creation: seta c_ruins.holder.var:transfered_dragon = dragon
	#   3. Cria story_dragon_variable_storage (on_setup lê transfered_dragon)
	#   4. Adiciona story à gl_dragon_variable_storage
	#   5. Mata o personagem temporário
	#   6. Chama agot_dragon_tree_creation_effect (árvore de talentos do dragão)
	#   7. Adiciona dragão à living_dragons global list se não estiver
	agot_dragon_transfer_vars_to_story_cycle_effect = { DRAGON = this }
}

# Conserta TODOS os dragões vivos que estão faltando no storage.
# Scope: qualquer personagem (chamado do player via decisão)
dob_fix_all_broken_dragons = {
	every_living_character = {
		limit = {
			has_trait = dragon
		}
		# Salva o dragão como scope nomeado ANTES de entrar no any_in_global_list
		# (padrão idêntico ao usado pelo AGOT em on_dragon_birthday)
		save_temporary_scope_as = current_dob_dragon_check
		if = {
			limit = {
				# Este dragão está faltando no storage system do AGOT?
				NOT = {
					any_in_global_list = {
						variable = gl_dragon_variable_storage
						var:dragon_id ?= scope:current_dob_dragon_check
					}
				}
			}
			dob_fix_single_dragon_storage = yes
		}
	}
}
