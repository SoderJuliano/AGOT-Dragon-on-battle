# ============================================================
# DRAGON ON BATTLE - Fix MDE Broken Dragons
# Conserta dragões criados pelo More Dragon Eggs que não foram
# registrados no sistema de armazenamento do AGOT (gl_dragon_variable_storage).
#
# CAUSA RAIZ:
#   AGOT armazena dragon_size_base em uma global list (gl_dragon_variable_storage)
#   via story cycles. Dragões criados por mods que não chamam
#   agot_dragon_transfer_vars_to_story_cycle_effect ficam invisíveis para esse
#   sistema → dragon_size sempre retorna 0 → Tame/Rename desabilitados.
#
# SOLUÇÃO:
#   Detectar dragões sem entrada no storage system (var:dragon_id não encontrado
#   em nenhuma story na gl_dragon_variable_storage) e chamar a função oficial do
#   AGOT para registrá-los, estimando dragon_size_base pela idade do personagem.
#
# Scope: o DRAGÃO (has_trait = dragon)
# ============================================================

# Estima dragon_size_base baseado na idade do dragão.
# Fórmula baseada na taxa de crescimento do AGOT:
#   Age < 11: +3 size/year (young phase)
#   Age 11-15: +2 size/year (adolescent)
#   Age 15+: +~1 size/year (adult, já crescido)
# Valores aproximados, conservadores (sem traits de physique).
dob_estimate_dragon_size_from_age = {
	if = {
		limit = { age >= 80 }
		set_variable = { name = dragon_size_base value = 175 }
	}
	else_if = {
		limit = { age >= 60 }
		set_variable = { name = dragon_size_base value = 150 }
	}
	else_if = {
		limit = { age >= 45 }
		set_variable = { name = dragon_size_base value = 120 }
	}
	else_if = {
		limit = { age >= 30 }
		set_variable = { name = dragon_size_base value = 90 }
	}
	else_if = {
		limit = { age >= 20 }
		set_variable = { name = dragon_size_base value = 60 }
	}
	else_if = {
		limit = { age >= 15 }
		set_variable = { name = dragon_size_base value = 40 }
	}
	else_if = {
		limit = { age >= 10 }
		set_variable = { name = dragon_size_base value = 30 }
	}
	else_if = {
		limit = { age >= 5 }
		set_variable = { name = dragon_size_base value = 15 }
	}
	else = {
		set_variable = { name = dragon_size_base value = 5 }
	}
}

# ─────────────────────────────────────────────────────────────────────────────
# Abordagem: DELETE & RECREATE
# Para cada dragão com tamanho 0 na story:
#   1. Estima tamanho correto pela idade
#   2. Apaga a story corrompida da gl_dragon_variable_storage e a encerra
#   3. Re-registra o dragão do zero via função oficial do AGOT
#      (que lê dragon_size_base e dragon_age do personagem do dragão)
# ─────────────────────────────────────────────────────────────────────────────

# Conserta um único dragão: apaga story corrompida e recria do zero.
# Scope: o DRAGÃO (has_trait = dragon)
# REQUER: scope:dob_fix_caller já salvo (o personagem do player, para contador)
dob_fix_single_dragon_delete_recreate = {
	# Passo 1: estimar tamanho correto e setar no personagem do dragão
	dob_estimate_dragon_size_from_age = yes

	# Garantir dragon_age no personagem (lido pelo on_setup da nova story)
	if = {
		limit = { NOT = { has_variable = dragon_age } }
		set_variable = { name = dragon_age value = { value = 0 add = age } }
	}

	# Passo 2: apagar story corrompida
	# Dentro de every_in_global_list: this = story object, prev = o dragão
	save_temporary_scope_as = dob_current_dragon
	every_in_global_list = {
		variable = gl_dragon_variable_storage
		limit = { var:dragon_id ?= scope:dob_current_dragon }
		# Remove da lista global
		remove_list_global_variable = {
			name = gl_dragon_variable_storage
			target = this
		}
		# Encerra a story cycle
		end_story = yes
	}

	# Passo 3: recriar do zero com tamanho estimado
	# agot_dragon_transfer_vars_to_story_cycle_effect lê dragon_size_base
	# e dragon_age do personagem do dragão (já setados acima)
	agot_dragon_transfer_vars_to_story_cycle_effect = { DRAGON = this }

	# Passo 4: incrementar contador no player
	scope:dob_fix_caller = {
		change_variable = { name = dob_fix_count add = 1 }
	}
}

# Conserta TODOS os dragões vivos com dragon_size 0 na story.
# Scope: o player (chamado da decisão)
dob_fix_all_broken_dragons = {
	# Salva o player como scope nomeado para o contador
	save_scope_as = dob_fix_caller
	set_variable = { name = dob_fix_count value = 0 }

	every_living_character = {
		limit = { has_trait = dragon }
		save_temporary_scope_as = current_dob_dragon_check
		if = {
			limit = {
				OR = {
					# Dragão está na lista com tamanho 0 na story
					any_in_global_list = {
						variable = gl_dragon_variable_storage
						var:dragon_id ?= scope:current_dob_dragon_check
						var:dragon_size_base <= 0
					}
					# Dragão não está na lista (mod sem registro)
					NOT = {
						any_in_global_list = {
							variable = gl_dragon_variable_storage
							var:dragon_id ?= scope:current_dob_dragon_check
						}
					}
				}
			}
			dob_fix_single_dragon_delete_recreate = yes
		}
	}
}
