# ============================================================
# DRAGON ON BATTLE - Fix MDE Broken Dragons
# Conserta dragões criados pelo More Dragon Eggs que não foram
# registrados no sistema de armazenamento do AGOT (gl_dragon_variable_storage).
#
# CAUSA RAIZ:
#   AGOT armazena dragon_size_base em uma global list (gl_dragon_variable_storage)
#   via story cycles. Dragões criados por mods que não chamam
#   agot_dragon_transfer_vars_to_story_cycle_effect ficam invisíveis para esse
#   sistema → dragon_size sempre retorna 0 → Tame/Rename desabilitados.
#
# SOLUÇÃO:
#   Detectar dragões sem entrada no storage system (var:dragon_id não encontrado
#   em nenhuma story na gl_dragon_variable_storage) e chamar a função oficial do
#   AGOT para registrá-los, estimando dragon_size_base pela idade do personagem.
#
# Scope: o DRAGÃO (has_trait = dragon)
# ============================================================

# Estima dragon_size_base baseado na idade do dragão.
# Fórmula baseada na taxa de crescimento do AGOT:
#   Age < 11: +3 size/year (young phase)
#   Age 11-15: +2 size/year (adolescent)
#   Age 15+: +~1 size/year (adult, já crescido)
# Valores aproximados, conservadores (sem traits de physique).
dob_estimate_dragon_size_from_age = {
	if = {
		limit = { age >= 80 }
		set_variable = { name = dragon_size_base value = 175 }
	}
	else_if = {
		limit = { age >= 60 }
		set_variable = { name = dragon_size_base value = 150 }
	}
	else_if = {
		limit = { age >= 45 }
		set_variable = { name = dragon_size_base value = 120 }
	}
	else_if = {
		limit = { age >= 30 }
		set_variable = { name = dragon_size_base value = 90 }
	}
	else_if = {
		limit = { age >= 20 }
		set_variable = { name = dragon_size_base value = 60 }
	}
	else_if = {
		limit = { age >= 15 }
		set_variable = { name = dragon_size_base value = 40 }
	}
	else_if = {
		limit = { age >= 10 }
		set_variable = { name = dragon_size_base value = 30 }
	}
	else_if = {
		limit = { age >= 5 }
		set_variable = { name = dragon_size_base value = 15 }
	}
	else = {
		set_variable = { name = dragon_size_base value = 5 }
	}
}

# Verifica se este dragão está faltando no storage system do AGOT.
# Scope: o DRAGÃO (this = dragon, dentro de any_in_global_list: this=story, prev=dragon)
dob_dragon_missing_from_agot_storage = {
	NOT = {
		# Existe alguma story no global list onde dragon_id = este dragão?
		any_in_global_list = {
			variable = gl_dragon_variable_storage
			var:dragon_id ?= prev
		}
	}
}

# Conserta um único dragão quebrado já registrado no storage mas com tamanho 0.
# Scope: o DRAGÃO (has_trait = dragon)
# Chamado de dentro de loops após confirmar que o dragão JÁ ESTÁ na lista.
dob_fix_single_dragon_in_storage = {
	# Estimar tamanho pela idade e colocar no personagem (temporário)
	dob_estimate_dragon_size_from_age = yes

	# Atualizar diretamente a story object na gl_dragon_variable_storage
	# O script value dragon_size_base lê this.var:dragon_size_base DA STORY
	save_temporary_scope_as = dob_dragon_to_fix
	every_in_global_list = {
		variable = gl_dragon_variable_storage
		limit = {
			var:dragon_id ?= scope:dob_dragon_to_fix
		}
		# Setar dragon_size_base na story com o valor estimado
		set_variable = {
			name = dragon_size_base
			value = scope:dob_dragon_to_fix.var:dragon_size_base
		}
		# Setar dragon_age na story
		set_variable = {
			name = dragon_age
			value = scope:dob_dragon_to_fix.age
		}
	}
}

# Conserta um único dragão que não está no storage (caso raro — MDE antigo).
# Scope: o DRAGÃO (has_trait = dragon)
dob_fix_single_dragon_storage = {
	# Garantir dragon_size_base no personagem (o on_setup da story lê daqui)
	if = {
		limit = { NOT = { has_variable = dragon_size_base } }
		dob_estimate_dragon_size_from_age = yes
	}
	else_if = {
		limit = { var:dragon_size_base <= 0 }
		dob_estimate_dragon_size_from_age = yes
	}

	# Garantir dragon_age no personagem
	if = {
		limit = { NOT = { has_variable = dragon_age } }
		set_variable = {
			name = dragon_age
			value = { value = 0 add = age }
		}
	}

	# Registrar no AGOT storage via função oficial
	agot_dragon_transfer_vars_to_story_cycle_effect = { DRAGON = this }
}

# Conserta TODOS os dragões vivos com problema de tamanho.
# Scope: qualquer personagem (chamado do player via decisão)
dob_fix_all_broken_dragons = {
	every_living_character = {
		limit = {
			has_trait = dragon
			agot_has_dragon_storage_system_global_list = yes
		}
		save_temporary_scope_as = current_dob_dragon_check
		if = {
			limit = {
				# Caso 1: Dragão está na lista mas o tamanho na story é 0
				any_in_global_list = {
					variable = gl_dragon_variable_storage
					var:dragon_id ?= scope:current_dob_dragon_check
					var:dragon_size_base <= 0
				}
			}
			dob_fix_single_dragon_in_storage = yes
		}
		else_if = {
			limit = {
				# Caso 2: Dragão não está na lista (MDE muito antigo / outro mod)
				NOT = {
					any_in_global_list = {
						variable = gl_dragon_variable_storage
						var:dragon_id ?= scope:current_dob_dragon_check
					}
				}
			}
			dob_fix_single_dragon_storage = yes
		}
	}
}
